<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0f172a; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; }

#map { width: 100%; height: calc(100vh - 140px); min-height: 280px; }

/* Controls */
.controls {
    display: flex;
    gap: 6px;
    padding: 10px 12px;
    background: #1e293b;
    overflow-x: auto;
}
.ctrl-btn {
    padding: 8px 14px;
    border: none;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    background: #334155;
    color: #94a3b8;
}
.ctrl-btn.active {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
}

/* Custom markers */
.country-marker {
    background: none !important;
    border: none !important;
}
.marker-dot {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 11px;
    color: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
}
.marker-dot:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 16px rgba(0,0,0,0.5);
}
.marker-dot.de {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    animation: pulse-de 2s infinite;
}
.marker-dot.partner {
    background: linear-gradient(135deg, #475569, #334155);
    border: 2px solid rgba(255,255,255,0.2);
}
.marker-dot.tariff-high { border: 2px solid #ef4444; }
.marker-dot.tariff-med { border: 2px solid #f59e0b; }
.marker-dot.tariff-none { border: 2px solid #22c55e; }

@keyframes pulse-de {
    0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5); }
    50% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
}

/* Info Panel */
.info-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, #1e293b, #0f172a);
    border-top: 1px solid #334155;
    padding: 16px;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    z-index: 1000;
    border-radius: 20px 20px 0 0;
}
.info-panel.open { transform: translateY(0); }
.info-panel .close-btn {
    position: absolute;
    top: 12px;
    right: 16px;
    background: none;
    border: none;
    color: #64748b;
    font-size: 24px;
    cursor: pointer;
}
.info-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}
.info-flag { font-size: 32px; }
.info-name { color: white; font-size: 18px; font-weight: 700; }
.info-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}
.info-item {
    background: #0f172a;
    border-radius: 12px;
    padding: 12px;
    text-align: center;
}
.info-item .val {
    font-size: 20px;
    font-weight: 700;
    color: white;
}
.info-item .val.green { color: #22c55e; }
.info-item .val.yellow { color: #f59e0b; }
.info-item .val.red { color: #ef4444; }
.info-item .label {
    font-size: 10px;
    color: #64748b;
    margin-top: 4px;
}

/* Stats Bar */
.stats {
    display: flex;
    justify-content: space-around;
    padding: 12px;
    background: #1e293b;
    border-top: 1px solid #334155;
}
.stats .stat { text-align: center; }
.stats .stat b { display: block; color: white; font-size: 18px; font-weight: 700; }
.stats .stat span { font-size: 10px; color: #64748b; }

/* Legend */
.legend {
    position: absolute;
    bottom: 20px;
    left: 10px;
    background: rgba(15, 23, 42, 0.9);
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 11px;
    color: #94a3b8;
    z-index: 500;
    backdrop-filter: blur(8px);
}
.legend-title { font-weight: 600; color: white; margin-bottom: 6px; }
.legend-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
.legend-line { width: 20px; height: 3px; border-radius: 2px; }
.legend-line.green { background: #22c55e; }
.legend-line.yellow { background: #f59e0b; }
.legend-line.red { background: #ef4444; }

/* Hide Leaflet attribution */
.leaflet-control-attribution { display: none !important; }
</style>
</head>
<body>

<div class="controls">
    <button class="ctrl-btn active" data-filter="all">üåç Alle</button>
    <button class="ctrl-btn" data-filter="tariff">üí∞ Mit Z√∂llen</button>
    <button class="ctrl-btn" data-filter="eu">üá™üá∫ EU</button>
    <button class="ctrl-btn" data-filter="top5">üìä Top 5</button>
</div>

<div id="map"></div>

<div class="legend">
    <div class="legend-title">Zolls√§tze</div>
    <div class="legend-row"><div class="legend-line green"></div> Zollfrei (0%)</div>
    <div class="legend-row"><div class="legend-line yellow"></div> Niedrig (1-10%)</div>
    <div class="legend-row"><div class="legend-line red"></div> Hoch (>10%)</div>
</div>

<div class="info-panel" id="infoPanel">
    <button class="close-btn" onclick="closePanel()">√ó</button>
    <div id="infoPanelContent"></div>
</div>

<div class="stats">
    <div class="stat"><b id="stat-routes">9</b><span>Handelsrouten</span></div>
    <div class="stat"><b id="stat-volume">993</b><span>Mrd ‚Ç¨ Volumen</span></div>
    <div class="stat"><b id="stat-tariff">6%</b><span>‚åÄ Zollsatz</span></div>
</div>

<script>
var countries = {
    de: { n: "Deutschland", f: "üá©üá™", lat: 51.17, lng: 10.45, eu: true },
    us: { n: "USA", f: "üá∫üá∏", lat: 37.09, lng: -95.71 },
    cn: { n: "China", f: "üá®üá≥", lat: 35.86, lng: 104.20 },
    jp: { n: "Japan", f: "üáØüáµ", lat: 36.20, lng: 138.25 },
    gb: { n: "UK", f: "üá¨üáß", lat: 55.38, lng: -3.44 },
    fr: { n: "Frankreich", f: "üá´üá∑", lat: 46.23, lng: 2.21, eu: true },
    br: { n: "Brasilien", f: "üáßüá∑", lat: -14.24, lng: -51.93 },
    ind: { n: "Indien", f: "üáÆüá≥", lat: 20.59, lng: 78.96 },
    kr: { n: "S√ºdkorea", f: "üá∞üá∑", lat: 35.91, lng: 127.77 },
    mx: { n: "Mexiko", f: "üá≤üáΩ", lat: 23.63, lng: -102.55 },
    nl: { n: "Niederlande", f: "üá≥üá±", lat: 52.13, lng: 5.29, eu: true },
    pl: { n: "Polen", f: "üáµüá±", lat: 51.92, lng: 19.15, eu: true },
    it: { n: "Italien", f: "üáÆüáπ", lat: 41.87, lng: 12.57, eu: true },
    at: { n: "√ñsterreich", f: "üá¶üáπ", lat: 47.52, lng: 14.55, eu: true }
};

var trades = [
    { to: "us", vol: 253, exp: 157, imp: 96, tariff: 15 },
    { to: "cn", vol: 298, exp: 107, imp: 191, tariff: 8 },
    { to: "gb", vol: 134, exp: 89, imp: 45, tariff: 0 },
    { to: "fr", vol: 172, exp: 102, imp: 70, tariff: 0 },
    { to: "jp", vol: 45, exp: 23, imp: 22, tariff: 5 },
    { to: "kr", vol: 28, exp: 14, imp: 14, tariff: 0 },
    { to: "br", vol: 21, exp: 12, imp: 9, tariff: 12 },
    { to: "ind", vol: 24, exp: 15, imp: 9, tariff: 10 },
    { to: "mx", vol: 18, exp: 11, imp: 7, tariff: 0 },
    { to: "nl", vol: 198, exp: 95, imp: 103, tariff: 0 },
    { to: "pl", vol: 156, exp: 82, imp: 74, tariff: 0 },
    { to: "it", vol: 142, exp: 78, imp: 64, tariff: 0 },
    { to: "at", vol: 125, exp: 72, imp: 53, tariff: 0 }
];

var map, lines = [], markers = [], animDots = [];
var currentFilter = 'all';

function init() {
    map = L.map("map", {
        center: [35, 10],
        zoom: 2,
        minZoom: 2,
        maxZoom: 8,
        zoomControl: false
    });

    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    renderTrades();
    setupFilters();
    updateStats();
}

function renderTrades() {
    clearMap();
    var de = countries.de;
    var filtered = getFilteredTrades();

    // Draw lines
    filtered.forEach(function(t, i) {
        var c = countries[t.to];
        if (!c) return;

        var color = t.tariff > 10 ? "#ef4444" : t.tariff > 0 ? "#f59e0b" : "#22c55e";
        var weight = Math.max(2, Math.min(6, t.vol / 50));

        var pts = [];
        for (var p = 0; p <= 30; p++) {
            var f = p / 30;
            var curve = Math.sin(Math.PI * f) * (15 + Math.abs(de.lng - c.lng) / 20);
            pts.push([
                de.lat + (c.lat - de.lat) * f + curve * (de.lat > 0 ? -0.5 : 0.5),
                de.lng + (c.lng - de.lng) * f
            ]);
        }

        var line = L.polyline(pts, {
            color: color,
            weight: weight,
            opacity: 0.6,
            className: 'trade-line'
        }).addTo(map);
        
        line.tradeData = t;
        lines.push(line);

        // Animated dot
        createAnimatedDot(pts, color, 3 + i * 0.3);
    });

    // Draw markers
    var drawnCountries = ['de'];
    filtered.forEach(function(t) { drawnCountries.push(t.to); });

    drawnCountries.forEach(function(id) {
        var c = countries[id];
        if (!c) return;

        var t = trades.find(function(x) { return x.to === id; });
        var isDE = id === 'de';
        var tariffClass = !t ? '' : t.tariff > 10 ? 'tariff-high' : t.tariff > 0 ? 'tariff-med' : 'tariff-none';

        var icon = L.divIcon({
            className: 'country-marker',
            html: '<div class="marker-dot ' + (isDE ? 'de' : 'partner ' + tariffClass) + '">' + 
                  (isDE ? 'üá©üá™' : c.f) + '</div>',
            iconSize: [isDE ? 44 : 36, isDE ? 44 : 36],
            iconAnchor: [isDE ? 22 : 18, isDE ? 22 : 18]
        });

        var marker = L.marker([c.lat, c.lng], { icon: icon }).addTo(map);
        marker.countryId = id;
        marker.on('click', function() { showPanel(id); });
        markers.push(marker);
    });

    updateStats(filtered);
}

function createAnimatedDot(path, color, duration) {
    var dot = document.createElement('div');
    dot.style.cssText = 'position:absolute;width:8px;height:8px;background:' + color + 
        ';border-radius:50%;box-shadow:0 0 10px ' + color + ';pointer-events:none;z-index:600;';
    document.body.appendChild(dot);
    animDots.push(dot);

    var idx = 0;
    function animate() {
        if (!dot.parentNode) return;
        var pt = map.latLngToContainerPoint(path[idx]);
        dot.style.left = pt.x - 4 + 'px';
        dot.style.top = pt.y + document.querySelector('.controls').offsetHeight - 4 + 'px';
        idx = (idx + 1) % path.length;
        setTimeout(animate, duration * 1000 / path.length);
    }
    animate();
}

function clearMap() {
    lines.forEach(function(l) { map.removeLayer(l); });
    markers.forEach(function(m) { map.removeLayer(m); });
    animDots.forEach(function(d) { if(d.parentNode) d.parentNode.removeChild(d); });
    lines = []; markers = []; animDots = [];
}

function getFilteredTrades() {
    return trades.filter(function(t) {
        var c = countries[t.to];
        if (currentFilter === 'tariff') return t.tariff > 0;
        if (currentFilter === 'eu') return c && c.eu;
        if (currentFilter === 'top5') return trades.indexOf(t) < 5;
        return true;
    });
}

function setupFilters() {
    document.querySelectorAll('.ctrl-btn').forEach(function(btn) {
        btn.onclick = function() {
            document.querySelectorAll('.ctrl-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            renderTrades();
        };
    });
}

function updateStats(filtered) {
    filtered = filtered || trades;
    var vol = 0, tar = 0, count = 0;
    filtered.forEach(function(t) { vol += t.vol; tar += t.tariff; count++; });
    document.getElementById('stat-routes').textContent = count;
    document.getElementById('stat-volume').textContent = vol;
    document.getElementById('stat-tariff').textContent = count ? Math.round(tar / count) + '%' : '0%';
}

function showPanel(id) {
    var c = countries[id];
    var t = trades.find(function(x) { return x.to === id; });
    var isDE = id === 'de';

    var tariffColor = !t ? '' : t.tariff > 10 ? 'red' : t.tariff > 0 ? 'yellow' : 'green';

    var html = '<div class="info-header"><span class="info-flag">' + c.f + '</span><span class="info-name">' + c.n + '</span></div>';
    
    if (t) {
        html += '<div class="info-grid">' +
            '<div class="info-item"><div class="val">' + t.exp + '</div><div class="label">Export Mrd ‚Ç¨</div></div>' +
            '<div class="info-item"><div class="val">' + t.imp + '</div><div class="label">Import Mrd ‚Ç¨</div></div>' +
            '<div class="info-item"><div class="val ' + tariffColor + '">' + t.tariff + '%</div><div class="label">Zollsatz</div></div>' +
        '</div>';
    } else if (isDE) {
        html += '<div class="info-grid">' +
            '<div class="info-item"><div class="val">1.655</div><div class="label">Export Mrd ‚Ç¨</div></div>' +
            '<div class="info-item"><div class="val">1.371</div><div class="label">Import Mrd ‚Ç¨</div></div>' +
            '<div class="info-item"><div class="val green">3.</div><div class="label">Exportnation</div></div>' +
        '</div>';
    }

    document.getElementById('infoPanelContent').innerHTML = html;
    document.getElementById('infoPanel').classList.add('open');
}

function closePanel() {
    document.getElementById('infoPanel').classList.remove('open');
}

// Close panel on map click
document.getElementById('map').addEventListener('click', function(e) {
    if (!e.target.closest('.marker-dot')) closePanel();
});

init();
</script>
</body>
</html>
