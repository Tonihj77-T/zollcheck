<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0f172a; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; }
body.fullscreen { position: fixed; inset: 0; z-index: 9999; }
body.fullscreen #map { height: 100vh !important; }
body.fullscreen .controls { position: absolute; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(30,41,59,0.95); }
body.fullscreen .stats { position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000; background: rgba(30,41,59,0.95); }
body.fullscreen .legend { bottom: 70px; }

#map { width: 100%; height: calc(100vh - 140px); min-height: 280px; }

.flow-line { stroke-dasharray: 8, 12; animation: flowDash 1.5s linear infinite; }
@keyframes flowDash { to { stroke-dashoffset: -40; } }

/* Controls */
.controls {
    display: flex;
    gap: 6px;
    padding: 14px 12px;
    padding-top: 18px;
    background: #1e293b;
    overflow-x: auto;
    align-items: center;
}
.ctrl-btn {
    padding: 8px 14px;
    border: none;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    background: #334155;
    color: #94a3b8;
}
.ctrl-btn.active {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}
.ctrl-btn.fullscreen-btn {
    margin-left: auto;
    background: #475569;
    padding: 8px 12px;
}
.ctrl-btn.fullscreen-btn:hover { background: #3b82f6; }

/* Fullscreen close button */
.fullscreen-close {
    display: none;
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 2000;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
body.fullscreen .fullscreen-close { display: flex; align-items: center; justify-content: center; }
body.fullscreen .fullscreen-btn { display: none; }

/* Markers */
.country-marker { background: none !important; border: none !important; }
.marker-dot {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    transition: transform 0.2s;
    cursor: pointer;
    background: #1e293b;
    border: 3px solid;
}
.marker-dot:hover { transform: scale(1.15); }
.marker-dot.de {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-color: #60a5fa;
    animation: pulse-de 2s infinite;
    font-size: 20px;
}
.marker-dot.tariff-high { border-color: #ef4444; background: linear-gradient(135deg, #1e293b, #2d1f1f); }
.marker-dot.tariff-med { border-color: #f59e0b; background: linear-gradient(135deg, #1e293b, #2d2a1f); }
.marker-dot.tariff-none { border-color: #22c55e; background: linear-gradient(135deg, #1e293b, #1f2d1f); }

@keyframes pulse-de {
    0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.6), 0 2px 8px rgba(0,0,0,0.4); }
    50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0), 0 2px 8px rgba(0,0,0,0.4); }
}

/* Info Panel */
.info-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(180deg, #1e293b, #0f172a);
    border-top: 1px solid #334155;
    padding: 16px;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    z-index: 1001;
    border-radius: 20px 20px 0 0;
    max-height: 70vh;
    overflow-y: auto;
}
.info-panel.open { transform: translateY(0); }
.info-panel .close-btn {
    position: absolute;
    top: 12px;
    right: 16px;
    background: none;
    border: none;
    color: #64748b;
    font-size: 24px;
    cursor: pointer;
}
.info-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
}
.info-flag { font-size: 36px; }
.info-name { color: white; font-size: 20px; font-weight: 700; }
.info-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}
.info-item {
    background: rgba(15, 23, 42, 0.8);
    border-radius: 12px;
    padding: 14px 10px;
    text-align: center;
    border: 1px solid #334155;
}
.info-item .val { font-size: 22px; font-weight: 700; color: white; }
.info-item .val.green { color: #22c55e; }
.info-item .val.yellow { color: #f59e0b; }
.info-item .val.red { color: #ef4444; }
.info-item .label { font-size: 10px; color: #64748b; margin-top: 4px; text-transform: uppercase; }

/* Products section */
.info-products {
    margin-top: 14px;
    padding: 12px;
    background: rgba(15, 23, 42, 0.6);
    border-radius: 12px;
    border: 1px solid #334155;
}
.info-products-title {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
    margin-bottom: 10px;
    font-weight: 600;
}
.info-products-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}
.info-products-row:last-child { margin-bottom: 0; }
.product-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 10px;
    background: #334155;
    border-radius: 8px;
    font-size: 12px;
    color: #e2e8f0;
}
.product-tag.export { background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.3); }
.product-tag.import { background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); }

.info-note {
    margin-top: 12px;
    padding: 10px 14px;
    background: rgba(59, 130, 246, 0.1);
    border-left: 3px solid #3b82f6;
    border-radius: 0 8px 8px 0;
    font-size: 12px;
    color: #94a3b8;
}

/* Stats Bar */
.stats {
    display: flex;
    justify-content: space-around;
    padding: 12px;
    background: #1e293b;
    border-top: 1px solid #334155;
}
.stats .stat { text-align: center; }
.stats .stat b { display: block; color: white; font-size: 18px; font-weight: 700; }
.stats .stat span { font-size: 10px; color: #64748b; }

/* Legend */
.legend {
    position: absolute;
    bottom: 20px;
    left: 10px;
    background: rgba(15, 23, 42, 0.95);
    padding: 12px 14px;
    border-radius: 12px;
    font-size: 11px;
    color: #94a3b8;
    z-index: 500;
    border: 1px solid #334155;
}
.legend-title { font-weight: 600; color: white; margin-bottom: 8px; }
.legend-row { display: flex; align-items: center; gap: 10px; margin: 6px 0; }
.legend-line { width: 24px; height: 4px; border-radius: 2px; }
.legend-line.green { background: #22c55e; box-shadow: 0 0 6px #22c55e; }
.legend-line.yellow { background: #f59e0b; box-shadow: 0 0 6px #f59e0b; }
.legend-line.red { background: #ef4444; box-shadow: 0 0 6px #ef4444; }

.leaflet-control-attribution { display: none !important; }
</style>
</head>
<body>

<div class="controls">
    <button class="ctrl-btn active" data-filter="all">üåç Alle</button>
    <button class="ctrl-btn" data-filter="tariff">üí∞ Mit Z√∂llen</button>
    <button class="ctrl-btn" data-filter="eu">üá™üá∫ EU</button>
    <button class="ctrl-btn" data-filter="top5">üìä Top 5</button>
    <button class="ctrl-btn fullscreen-btn" onclick="toggleFullscreen()">‚õ∂</button>
</div>

<button class="fullscreen-close" onclick="toggleFullscreen()">‚úï</button>
<div id="map"></div>

<div class="legend">
    <div class="legend-title">Zolls√§tze</div>
    <div class="legend-row"><div class="legend-line green"></div> Zollfrei</div>
    <div class="legend-row"><div class="legend-line yellow"></div> 1-15%</div>
    <div class="legend-row"><div class="legend-line red"></div> √úber 15%</div>
</div>

<div class="info-panel" id="infoPanel">
    <button class="close-btn" onclick="closePanel()">√ó</button>
    <div id="infoPanelContent"></div>
</div>

<div class="stats">
    <div class="stat"><b id="stat-routes">13</b><span>Handelsrouten</span></div>
    <div class="stat"><b id="stat-volume">1.614</b><span>Mrd ‚Ç¨ Volumen</span></div>
    <div class="stat"><b id="stat-tariff">4%</b><span>‚åÄ Zollsatz</span></div>
</div>

<script>
var countries = {
    de: { n: "Deutschland", f: "üá©üá™", lat: 51.17, lng: 10.45, eu: true },
    us: { n: "USA", f: "üá∫üá∏", lat: 38.5, lng: -98 },
    cn: { n: "China", f: "üá®üá≥", lat: 35, lng: 103 },
    jp: { n: "Japan", f: "üáØüáµ", lat: 36.5, lng: 138 },
    gb: { n: "UK", f: "üá¨üáß", lat: 54, lng: -2 },
    fr: { n: "Frankreich", f: "üá´üá∑", lat: 46.5, lng: 2.5, eu: true },
    br: { n: "Brasilien", f: "üáßüá∑", lat: -10, lng: -52 },
    ind: { n: "Indien", f: "üáÆüá≥", lat: 22, lng: 79 },
    kr: { n: "S√ºdkorea", f: "üá∞üá∑", lat: 36, lng: 128 },
    mx: { n: "Mexiko", f: "üá≤üáΩ", lat: 24, lng: -102 },
    nl: { n: "Niederlande", f: "üá≥üá±", lat: 52.2, lng: 5.5, eu: true },
    pl: { n: "Polen", f: "üáµüá±", lat: 52, lng: 19, eu: true },
    it: { n: "Italien", f: "üáÆüáπ", lat: 42.5, lng: 12.5, eu: true },
    at: { n: "√ñsterreich", f: "üá¶üáπ", lat: 47.5, lng: 14.5, eu: true }
};

// Handelsdaten inkl. Top-Produkte (Stand 2025/26)
var trades = [
    { 
        to: "us", vol: 253, exp: 157, imp: 96, tariff: 15, 
        note: "Trump 2.0: 15% auf Autos, 10% Baseline auf alle EU-Waren",
        topExports: ["üöó Autos & Teile", "‚öôÔ∏è Maschinen", "üíä Pharma"],
        topImports: ["‚úàÔ∏è Flugzeuge", "üíª Software", "üõ¢Ô∏è √ñl/Gas"]
    },
    { 
        to: "cn", vol: 298, exp: 107, imp: 191, tariff: 25, 
        note: "Chinas Gegenz√∂lle auf EU-Produkte",
        topExports: ["üöó Autos", "‚öôÔ∏è Maschinen", "üî¨ Optik/Medizin"],
        topImports: ["üì± Elektronik", "üîã Batterien", "üëï Textilien"]
    },
    { 
        to: "gb", vol: 134, exp: 89, imp: 45, tariff: 0, 
        note: "EU-UK Trade and Cooperation Agreement (TCA)",
        topExports: ["üöó Autos", "‚öôÔ∏è Maschinen", "üíä Pharma"],
        topImports: ["üõ¢Ô∏è √ñl/Gas", "üíé Gold", "‚úàÔ∏è Flugzeugteile"]
    },
    { 
        to: "jp", vol: 45, exp: 23, imp: 22, tariff: 0, 
        note: "EU-Japan Economic Partnership seit 2019",
        topExports: ["üöó Autos", "üíä Pharma", "‚öôÔ∏è Maschinen"],
        topImports: ["üöó Autos", "üì± Elektronik", "‚öôÔ∏è Maschinen"]
    },
    { 
        to: "kr", vol: 28, exp: 14, imp: 14, tariff: 0, 
        note: "EU-Korea Freihandelsabkommen seit 2011",
        topExports: ["üöó Autos", "‚öôÔ∏è Maschinen", "üß™ Chemie"],
        topImports: ["üì± Elektronik", "üöó Autos", "üîã Batterien"]
    },
    { 
        to: "br", vol: 21, exp: 12, imp: 9, tariff: 18, 
        note: "Mercosur-Z√∂lle, EU-Abkommen noch nicht ratifiziert",
        topExports: ["‚öôÔ∏è Maschinen", "üöó Autoteile", "üß™ Chemie"],
        topImports: ["ü•© Fleisch", "‚òï Kaffee", "üå± Soja"]
    },
    { 
        to: "ind", vol: 24, exp: 15, imp: 9, tariff: 22, 
        note: "WTO MFN-Z√∂lle, EU-Indien FTA in Verhandlung",
        topExports: ["‚öôÔ∏è Maschinen", "üß™ Chemie", "‚úàÔ∏è Flugzeugteile"],
        topImports: ["üíä Pharma", "üëï Textilien", "üíé Schmuck"]
    },
    { 
        to: "mx", vol: 18, exp: 11, imp: 7, tariff: 5, 
        note: "EU-Mexiko Global Agreement (2020)",
        topExports: ["üöó Autos", "‚öôÔ∏è Maschinen", "üß™ Chemie"],
        topImports: ["üöó Autoteile", "üì± Elektronik", "ü•ë Lebensmittel"]
    },
    { 
        to: "fr", vol: 172, exp: 102, imp: 70, tariff: 0, 
        note: "EU-Binnenmarkt",
        topExports: ["üöó Autos", "‚öôÔ∏è Maschinen", "üß™ Chemie"],
        topImports: ["‚úàÔ∏è Flugzeuge (Airbus)", "üç∑ Wein", "üíä Pharma"]
    },
    { 
        to: "nl", vol: 198, exp: 95, imp: 103, tariff: 0, 
        note: "EU-Binnenmarkt + wichtiger Logistik-Hub",
        topExports: ["‚öôÔ∏è Maschinen", "üß™ Chemie", "üöó Autos"],
        topImports: ["üõ¢Ô∏è √ñl (Rotterdam)", "üì± Elektronik", "üß™ Chemie"]
    },
    { 
        to: "pl", vol: 156, exp: 82, imp: 74, tariff: 0, 
        note: "EU-Binnenmarkt + wichtiger Produktionsstandort",
        topExports: ["üöó Autoteile", "‚öôÔ∏è Maschinen", "üß™ Chemie"],
        topImports: ["üöó Autoteile", "ü™ë M√∂bel", "ü•© Lebensmittel"]
    },
    { 
        to: "it", vol: 142, exp: 78, imp: 64, tariff: 0, 
        note: "EU-Binnenmarkt",
        topExports: ["üöó Autos", "‚öôÔ∏è Maschinen", "üß™ Chemie"],
        topImports: ["‚öôÔ∏è Maschinen", "üëó Mode/Textil", "üçù Lebensmittel"]
    },
    { 
        to: "at", vol: 125, exp: 72, imp: 53, tariff: 0, 
        note: "EU-Binnenmarkt + enge Wirtschaftsbeziehung",
        topExports: ["üöó Autos", "‚öôÔ∏è Maschinen", "üß™ Chemie"],
        topImports: ["‚öôÔ∏è Maschinen", "üî© Metallwaren", "ü™µ Holz"]
    }
];

var map, lines = [], markers = [];
var currentFilter = 'all';
var isFullscreen = false;

function init() {
    map = L.map("map", {
        center: [30, 10],
        zoom: 2,
        minZoom: 2,
        maxZoom: 8,
        zoomControl: false
    });

    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    renderTrades();
    setupFilters();
}

function toggleFullscreen() {
    isFullscreen = !isFullscreen;
    document.body.classList.toggle('fullscreen', isFullscreen);
    document.querySelector('.fullscreen-btn').textContent = isFullscreen ? '‚úï' : '‚õ∂';
    
    // Notify parent iframe
    if (window.parent !== window) {
        window.parent.postMessage({ type: 'fullscreen', value: isFullscreen }, '*');
    }
    
    setTimeout(function() { map.invalidateSize(); }, 100);
}

function renderTrades() {
    clearMap();
    var de = countries.de;
    var filtered = getFilteredTrades();

    filtered.forEach(function(t) {
        var c = countries[t.to];
        if (!c) return;

        var color = t.tariff > 15 ? "#ef4444" : t.tariff > 0 ? "#f59e0b" : "#22c55e";
        var weight = Math.max(2, Math.min(5, t.vol / 60));

        var pts = [];
        var midLat = (de.lat + c.lat) / 2;
        var midLng = (de.lng + c.lng) / 2;
        var dist = Math.sqrt(Math.pow(de.lat - c.lat, 2) + Math.pow(de.lng - c.lng, 2));
        var curveOffset = dist * 0.2;
        var curveLat = midLat + curveOffset;
        
        for (var i = 0; i <= 30; i++) {
            var t2 = i / 30;
            var lat = Math.pow(1-t2, 2) * de.lat + 2 * (1-t2) * t2 * curveLat + Math.pow(t2, 2) * c.lat;
            var lng = Math.pow(1-t2, 2) * de.lng + 2 * (1-t2) * t2 * midLng + Math.pow(t2, 2) * c.lng;
            pts.push([lat, lng]);
        }

        var baseLine = L.polyline(pts, { color: color, weight: weight + 2, opacity: 0.15, lineCap: 'round' }).addTo(map);
        lines.push(baseLine);

        var flowLine = L.polyline(pts, { color: color, weight: weight, opacity: 0.9, lineCap: 'round', dashArray: '8, 12', className: 'flow-line' }).addTo(map);
        flowLine.tradeData = t;
        lines.push(flowLine);
    });

    var drawnCountries = ['de'];
    filtered.forEach(function(t) { drawnCountries.push(t.to); });
    drawnCountries = [...new Set(drawnCountries)];

    drawnCountries.forEach(function(id) {
        var c = countries[id];
        if (!c) return;

        var t = trades.find(function(x) { return x.to === id; });
        var isDE = id === 'de';
        var tariffClass = !t ? 'tariff-none' : t.tariff > 15 ? 'tariff-high' : t.tariff > 0 ? 'tariff-med' : 'tariff-none';

        var size = isDE ? 48 : 40;
        var icon = L.divIcon({
            className: 'country-marker',
            html: '<div class="marker-dot ' + (isDE ? 'de' : tariffClass) + '">' + c.f + '</div>',
            iconSize: [size, size],
            iconAnchor: [size/2, size/2]
        });

        var marker = L.marker([c.lat, c.lng], { icon: icon }).addTo(map);
        marker.countryId = id;
        marker.on('click', function() { showPanel(id); });
        markers.push(marker);
    });

    updateStats(filtered);
}

function clearMap() {
    lines.forEach(function(l) { map.removeLayer(l); });
    markers.forEach(function(m) { map.removeLayer(m); });
    lines = []; markers = [];
}

function getFilteredTrades() {
    var sorted = trades.slice().sort(function(a,b) { return b.vol - a.vol; });
    return trades.filter(function(t) {
        var c = countries[t.to];
        if (currentFilter === 'tariff') return t.tariff > 0;
        if (currentFilter === 'eu') return c && c.eu;
        if (currentFilter === 'top5') return sorted.indexOf(t) < 5;
        return true;
    });
}

function setupFilters() {
    document.querySelectorAll('.ctrl-btn[data-filter]').forEach(function(btn) {
        btn.onclick = function() {
            document.querySelectorAll('.ctrl-btn[data-filter]').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            renderTrades();
        };
    });
}

function updateStats(filtered) {
    var vol = 0, tar = 0, count = 0;
    filtered.forEach(function(t) { vol += t.vol; tar += t.tariff; count++; });
    document.getElementById('stat-routes').textContent = count;
    document.getElementById('stat-volume').textContent = vol.toLocaleString('de-DE');
    document.getElementById('stat-tariff').textContent = count ? Math.round(tar / count) + '%' : '0%';
}

function showPanel(id) {
    var c = countries[id];
    var t = trades.find(function(x) { return x.to === id; });
    var isDE = id === 'de';

    var tariffColor = !t ? 'green' : t.tariff > 15 ? 'red' : t.tariff > 0 ? 'yellow' : 'green';

    var html = '<div class="info-header"><span class="info-flag">' + c.f + '</span><span class="info-name">' + c.n + '</span></div>';
    
    if (t) {
        html += '<div class="info-grid">' +
            '<div class="info-item"><div class="val">' + t.exp + '</div><div class="label">Export Mrd ‚Ç¨</div></div>' +
            '<div class="info-item"><div class="val">' + t.imp + '</div><div class="label">Import Mrd ‚Ç¨</div></div>' +
            '<div class="info-item"><div class="val ' + tariffColor + '">' + t.tariff + '%</div><div class="label">Zollsatz</div></div>' +
        '</div>';
        
        // Products section
        html += '<div class="info-products">';
        html += '<div class="info-products-title">üá©üá™ Top Exporte nach ' + c.n + '</div>';
        html += '<div class="info-products-row">' + t.topExports.map(function(p) { return '<span class="product-tag export">' + p + '</span>'; }).join('') + '</div>';
        html += '<div class="info-products-title" style="margin-top:10px">üì• Top Importe aus ' + c.n + '</div>';
        html += '<div class="info-products-row">' + t.topImports.map(function(p) { return '<span class="product-tag import">' + p + '</span>'; }).join('') + '</div>';
        html += '</div>';
        
        html += '<div class="info-note">‚ÑπÔ∏è ' + t.note + '</div>';
    } else if (isDE) {
        html += '<div class="info-grid">' +
            '<div class="info-item"><div class="val">1.655</div><div class="label">Export Mrd ‚Ç¨</div></div>' +
            '<div class="info-item"><div class="val">1.371</div><div class="label">Import Mrd ‚Ç¨</div></div>' +
            '<div class="info-item"><div class="val green">#3</div><div class="label">Weltweit</div></div>' +
        '</div>';
        html += '<div class="info-products">';
        html += '<div class="info-products-title">üá©üá™ Top Export-G√ºter weltweit</div>';
        html += '<div class="info-products-row"><span class="product-tag export">üöó Autos</span><span class="product-tag export">‚öôÔ∏è Maschinen</span><span class="product-tag export">üß™ Chemie</span></div>';
        html += '<div class="info-products-row"><span class="product-tag export">üíä Pharma</span><span class="product-tag export">üì± Elektro</span></div>';
        html += '</div>';
        html += '<div class="info-note">‚ÑπÔ∏è Deutschland ist die drittgr√∂√üte Exportnation der Welt nach China und den USA.</div>';
    }

    document.getElementById('infoPanelContent').innerHTML = html;
    document.getElementById('infoPanel').classList.add('open');
}

function closePanel() {
    document.getElementById('infoPanel').classList.remove('open');
}

document.getElementById('map').addEventListener('click', function(e) {
    if (!e.target.closest('.marker-dot')) closePanel();
});

// Handle escape key for fullscreen
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isFullscreen) toggleFullscreen();
});

init();
</script>
</body>
</html>
